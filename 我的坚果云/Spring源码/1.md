## 手把手带你吃透Spring框架核心源码

### 备注

主要笔记来自 儒猿技术窝：https://apppukyptrl1086.pc.xiaoe-tech.com/detail/p_620dbc7de4b04d7e2fcca5a0/6

在学习的时候可以结合 <<手撸Spring>>* 小傅哥.pdf 及学习笔记一块学习。https://github.com/fuzhengwei/small-spring

### 2、Resource 到底是个什么玩意儿

##### 初始ClassPathResource

从 ClassPathResource 加载 applicationContext.xml 开始，了解下 ClassPathResource 是什么。

ClassPathResource 其实就是一个实现了 Resource 接口的实现类而已。和 ClassPathResource 类似的还有 UrlResource、FileSystemResource 和 InputStreamResource，它们都实现了 Resource 接口，而 Resource 接口又实现了 InputStreamSource 接口。

##### Resource和InputStreamSource

首先，我们来回答第一个问题：什么是 Resource 接口？ =》`Spring 统一把所有使用到的资源都抽象成了 Resource，不同来源的资源对应着不同的 Resource 实现类。`

我们可以来看一下 Resource 接口中，都有哪些方法：

<img src="1.assets/image-20220309133257298.png" alt="image-20220309133257298" style="zoom:50%;" />

再来看看 InputStreamSource 接口是什么呢？

<img src="1.assets/image-20220309133427559.png" alt="image-20220309133427559" style="zoom:50%;" />

可以看到 InputStreamSource 接口中只有一个方法 getInputStream，而且方法返回的就是要给输入流 InputStream。

这也就意味着所有资源只要封装成了Resource，就可以通过调用 InputStreamResource 中的 getInputStream方法，获取资源对应的输入流 InputStream 了。

##### 各种Resource是如何加载资源的呢？

ClassPathResource：

```java
public class ClassPathResource implements Resource {

    private final String path;

    private ClassLoader classLoader;

    public ClassPathResource(String path) {
        this(path, (ClassLoader) null);
    }

    public ClassPathResource(String path, ClassLoader classLoader) {
        Assert.notNull(path, "Path must not be null");
        this.path = path;
        this.classLoader = (classLoader != null ? classLoader : ClassUtils.getDefaultClassLoader());
    }

    @Override
    public InputStream getInputStream() throws IOException {
        InputStream is = classLoader.getResourceAsStream(path);
        if (is == null) {
            throw new FileNotFoundException(
                    this.path + " cannot be opened because it does not exist");
        }
        return is;
    }
}
```

就是通过 classLoader 的底层方法来加载的，没什么特别的地方。

FileSystemResource：

```java
public class FileSystemResource implements Resource {

    private final File file;

    private final String path;

    public FileSystemResource(File file) {
        this.file = file;
        this.path = file.getPath();
    }

    public FileSystemResource(String path) {
        this.file = new File(path);
        this.path = path;
    }

    @Override
    public InputStream getInputStream() throws IOException {
        return new FileInputStream(this.file);
    }

    public final String getPath() {
        return this.path;
    }

}
```

更简单，无非是通过 JDK 底层方法，根据文件的路径去加载资源的 InputStrean。

UrlResource：

```java
public class UrlResource implements Resource{

    private final URL url;

    public UrlResource(URL url) {
        Assert.notNull(url,"URL must not be null");
        this.url = url;
    }

    @Override
    public InputStream getInputStream() throws IOException {
        URLConnection con = this.url.openConnection();
        try {
            return con.getInputStream();
        }
        catch (IOException ex){
            if (con instanceof HttpURLConnection){
                ((HttpURLConnection) con).disconnect();
            }
            throw ex;
        }
    }

}
```

通过对应 URL 连接去获取 InputStream。

