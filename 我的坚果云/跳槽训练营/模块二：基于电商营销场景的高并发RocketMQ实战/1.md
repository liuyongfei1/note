## 模块二：基于电商营销场景的高并发RocketMQ实战

### 004_基于Topic队列机制实现的数据分片架构

### 005

比如，一个集群里包含两个broker分组。

当在RocketMQ里创建一个topic后，会在每个 broker里默认创建4个写队列，4个读队列。

每个broker在心跳的时候，会把这个topic创建的队列 这个数据也上报给 NameServer（注册中心）。

### 006 Producer基于队列的消息分发机制

#### 1、消息是如何发送到broker去的

发送消息，肯定是指定一个topic，往topic里去进行一个发送。

需要获取topic，有哪些queue，这个queue分布在哪些broker上。

1. 业务系统（Producer）会从NameServer里拉取topic路由信息（这个topic路由到哪些queue，queue又路由到哪些broker上）;
2. 拉取回来之后，会在本地做一个缓存。然后会每隔30s去NameServer拉取一次，做更新；
3. 然后Producer会根据获取到的queues的路由信息，去做负载均衡，轮询，将消息发送给对应的queue（通过路由信息，由queue找到broker分组，找到broker分组，就能找到哪个是主，哪个是从），然后往主节点里写消息。

#### 2、如果发送的消息失败了，怎么处理

1. 假如在发送的时候，哪个broker出现了故障，导致消息发送失败了，默认来说，会有一次重试；=》故障重试机制
2. 会把有故障的broker做一个缓存，下一次（在一定时间段内）选的时候就不会选这个broker了；=》故障退避机制
3. 重试会重新选择一个queue，再去重新选择一个broker，再发送消息。

#### 3、发送消息的时候，有哪些比较高阶的特性可以使用

按照key进行hash。

比如：你想让 orderId相同的消息，比如 orderId = 001，都进入到一个queue里去，以保证消息的顺序性。

