## 模块二：基于电商营销场景的高并发RocketMQ实战

### 004_基于Topic队列机制实现的数据分片架构

### 005

比如，一个集群里包含两个broker分组。

当在RocketMQ里创建一个topic后，会在每个 broker里默认创建4个写队列，4个读队列。

每个broker在心跳的时候，会把这个topic创建的队列 这个数据也上报给 NameServer（注册中心）。

### 006 Producer基于队列的消息分发机制

#### 1、消息是如何发送到broker去的

发送消息，肯定是指定一个topic，往topic里去进行一个发送。

需要获取topic，有哪些queue，这个queue分布在哪些broker上。

1. 业务系统（Producer）会从NameServer里拉取topic路由信息（这个topic路由到哪些queue，queue又路由到哪些broker上）;
2. 拉取回来之后，会在本地做一个缓存。然后会每隔30s去NameServer拉取一次，做更新；
3. 然后Producer会根据获取到的queues的路由信息，去做负载均衡，轮询，将消息发送给对应的queue（通过路由信息，由queue找到broker分组，找到broker分组，就能找到哪个是主，哪个是从），然后往主节点里写消息。

#### 2、如果发送的消息失败了，怎么处理

1. 假如在发送的时候，哪个broker出现了故障，导致消息发送失败了，默认来说，会有一次重试；=》故障重试机制
2. 会把有故障的broker做一个缓存，下一次（在一定时间段内）选的时候就不会选这个broker了；=》故障退避机制
3. 重试会重新选择一个queue，再去重新选择一个broker，再发送消息。

### 007_Producer基于hash的有序消息分发

#### 3、发送消息的时候，有哪些比较高阶的特性可以使用

默认情况下，我们往一个topic里写入的数据，会均匀分散到各个broker的各个queue里去，也就是说每个queue里都有一些我们这个topic的数据。

同一个 queue 就代表了一个队列，所以消息进入到同一个queue里去的时候，在同一个queue里的消息是有序的。但是不同的queue之间的消息是没有顺序的。



如果有一些场景，需要让某一类数据有一定的特殊顺序性：

**比如：你想让 orderId相同的消息，比如 orderId = 001，都进入到一个queue里去，以保证消息的顺序性。**

解决办法：按照key进行hash，用这个字段的hash值，对queue的数量进行取模，就可以确保：同一个字段值 -》同一个hash值 -》取模出来同一个queue序号 -》进入同一个queue。

这个queue 就是相当于 数据分片。

补充一下：broker 还有一个故障延迟感知机制，就是说NameServer 在发现某个 broker 出现故障了，不会立马同步给各个Producer，这样处理起来会有点复杂。而且还有故障重试机制和故障退避机制来做一定的弥补。

Producer（client端） 会每隔30s拿一下最新的topic路由消息，自然而然有故障的broker的路由就被排除掉了。