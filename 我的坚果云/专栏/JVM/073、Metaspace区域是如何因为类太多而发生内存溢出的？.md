## **073、Metaspace区域是如何因为类太多而发生内存溢出的？**

### 2、Metaspace区域是如何触发内存溢出的

#### 如下两个参数是用来设置Metaspace区域大小的

```bash
-XX:MetaspaceSize=512m
-XX:MaxMetaspaceSize=512m
```

所以，实际上来说，在一个JVM中，Metaspace 区域的大小是固定的，比如：512MB。

那么，一旦JVM不停的加载类，加载了很多很多的类，然后Metaspace区域放满了。

这个时候就会触发Full GC，Full GC 会带着一块进行 Old GC就是回收老年代的，也会带着回收Yong GC。

**当然，Full GC的时候，必然会尝试着回收Metaspace区域中的类，那么什么样的类才是可以被回收的呢？**

这个条件是相当苛刻的，包括但不限于以下一些：比如这个类的类加载器要被回收，比如这个类的所有对象实例都要被回收，等等。

所以，一旦你的Metaspace区域满了，未必能回收掉里面很多的类。

那么，一旦回收不了多少泪，此时你的JVM还在拼命的加载类放到Metaspace里去，这个时候，就有可能会引发内存溢出的问题。因为此时Metaspace区域的内存空间不够了。

**一旦发生了内存溢出，就说明JVM已经没办法继续运行下去了，此时可能你的系统就直接崩溃了，这就是Metaspace发生内存溢出的一个根本的原理。**

### 3、到底什么情况下会发生Metaspace内存溢出

一般都是因为两个原因：

- 第一种原因：很多工程师不懂JVM的运行原理，在上线系统的时候对Metaspace区域直接用默认的参数，即根本不设置其大小，这会导致默认的Metaspace区域可能也才几十MB而已。此时对于一个稍微大型一点的系统，因为他自己有很多类，还依赖了很多外部的jar包有很多的类，几十MB的Metaspace很容易就不够了。
- 第二种原因：就是很多人写系统的时候会用cglib之类的技术动态生成一些类，一旦代码中没有控制好，导致你生成的类过于多的时候，就很容易把Metaspace给塞满，进而引发内存溢出。

对于第一种问题，通常来说，对于有经验的工程师上线系统往往会设置对应的Metaspace大小，一般推荐的值为512MB那样，一般都是足够的。

对于第二种问题，看下一节的演示。

